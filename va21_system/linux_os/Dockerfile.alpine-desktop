# VA21 Research OS - Alpine Desktop Edition
# ===========================================
# Lightweight Desktop OS based on Alpine Linux
# Uses VA21's own advanced interface (no external DE needed)
#
# Alpine provides a minimal footprint (~50MB base) with:
#   - musl libc (lightweight alternative to glibc)
#   - BusyBox utilities (compact GNU-like tools)
#   - OpenRC init system
#
# Features:
#   - VA21 Zork-style text adventure interface
#   - Spotlight-like launcher (Ctrl+Space)
#   - Tiling window manager
#   - AI-powered command interface (chat to control)
#   - WiFi, Audio, Display, Time settings
#   - Guardian AI security
#
# Installation targets:
#   - Docker / Podman (containerized)
#   - VirtualBox / VMware (virtual machine)
#   - Physical Hardware (bare metal installation)
#
# Om Vinayaka - Lightweight power, full capability.
#
# Build: docker build -f Dockerfile.alpine-desktop -t va21-desktop-os:alpine .
# Run:   docker run -it --rm va21-desktop-os:alpine

# ============================================
# Stage 1: Base System
# ============================================
FROM alpine:3.19 AS base

LABEL maintainer="Prayaga Vaibhav"
LABEL description="VA21 Desktop OS - Alpine Edition (Lightweight)"
LABEL version="1.0.0"
LABEL base="alpine"
LABEL type="desktop"

# ============================================
# Core System Utilities
# ============================================

RUN apk add --no-cache \
    # ----------------------------------------
    # Core Utilities
    # ----------------------------------------
    coreutils \
    busybox-extras \
    util-linux \
    shadow \
    sudo \
    # ----------------------------------------
    # Shell and Terminal
    # ----------------------------------------
    bash \
    bash-completion \
    ncurses \
    readline \
    # ----------------------------------------
    # Text Processing
    # ----------------------------------------
    grep \
    sed \
    gawk \
    diffutils \
    patch \
    less \
    # ----------------------------------------
    # File Utilities
    # ----------------------------------------
    findutils \
    file \
    tree \
    rsync \
    # ----------------------------------------
    # Compression
    # ----------------------------------------
    gzip \
    bzip2 \
    xz \
    tar \
    zip \
    unzip \
    p7zip \
    # ----------------------------------------
    # Build Tools
    # ----------------------------------------
    make \
    # ----------------------------------------
    # System
    # ----------------------------------------
    procps \
    psmisc \
    openrc \
    dbus \
    eudev \
    # ----------------------------------------
    # Networking & WiFi
    # ----------------------------------------
    iproute2 \
    iputils \
    net-tools \
    netcat-openbsd \
    curl \
    wget \
    bind-tools \
    openssh \
    # WiFi tools
    wireless-tools \
    wpa_supplicant \
    networkmanager \
    # ----------------------------------------
    # Audio
    # ----------------------------------------
    pulseaudio \
    pulseaudio-utils \
    alsa-lib \
    alsa-utils \
    # ----------------------------------------
    # Display/X11
    # ----------------------------------------
    xterm \
    # ----------------------------------------
    # Time & Date
    # ----------------------------------------
    chrony \
    tzdata \
    # ----------------------------------------
    # Development
    # ----------------------------------------
    strace \
    # ----------------------------------------
    # Security
    # ----------------------------------------
    nmap \
    gnupg \
    # ----------------------------------------
    # Editors
    # ----------------------------------------
    vim \
    nano \
    # ----------------------------------------
    # Multiplexers
    # ----------------------------------------
    tmux \
    screen \
    # ----------------------------------------
    # Monitoring
    # ----------------------------------------
    htop \
    # ----------------------------------------
    # JSON
    # ----------------------------------------
    jq \
    # ----------------------------------------
    # Version Control
    # ----------------------------------------
    git \
    # ----------------------------------------
    # Games (Z-Machine interpreter for Zork)
    # ----------------------------------------
    frotz \
    # ----------------------------------------
    # Python
    # ----------------------------------------
    python3 \
    py3-pip \
    py3-psutil \
    py3-yaml \
    py3-requests \
    # ----------------------------------------
    # ClamAV
    # ----------------------------------------
    clamav \
    clamav-daemon \
    clamav-libunrar \
    # ----------------------------------------
    # CA Certificates
    # ----------------------------------------
    ca-certificates \
    # ----------------------------------------
    # Fonts
    # ----------------------------------------
    font-dejavu \
    ttf-liberation \
    && rm -rf /var/cache/apk/*

# ============================================
# System Configuration
# ============================================

# Initialize ClamAV database directory
RUN mkdir -p /var/lib/clamav && \
    chown clamav:clamav /var/lib/clamav

# ============================================
# VA21 User and Directory Setup
# ============================================

RUN adduser -D -h /home/researcher -s /bin/bash -u 1000 researcher && \
    echo "researcher:va21" | chpasswd && \
    adduser researcher wheel && \
    adduser researcher audio && \
    adduser researcher video && \
    echo "%wheel ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers && \
    mkdir -p /va21/{guardian,vault,research,sandbox,logs,config,desktop,games} && \
    mkdir -p /home/researcher/{research,notes,tools,Desktop,Documents,Downloads,Pictures} && \
    chown -R researcher:researcher /va21 /home/researcher

# ============================================
# Python Dependencies for VA21
# ============================================

COPY requirements.txt /tmp/requirements.txt
RUN pip3 install --no-cache-dir --break-system-packages -r /tmp/requirements.txt 2>/dev/null || \
    pip3 install --no-cache-dir -r /tmp/requirements.txt && \
    rm /tmp/requirements.txt

# ============================================
# Copy VA21 Components
# ============================================

COPY guardian/ /va21/guardian/
COPY zork_shell/ /va21/zork_shell/
COPY searxng/ /va21/searxng/
COPY window_manager/ /va21/window_manager/
COPY launcher/ /va21/launcher/
COPY system_tools/ /va21/system_tools/
COPY games/ /va21/games/
COPY scripts/entrypoint.sh /va21/entrypoint.sh
COPY config/ /va21/config/

# Make scripts executable
RUN chmod +x /va21/entrypoint.sh && \
    find /va21 -name "*.py" -exec chmod +x {} \; && \
    find /va21 -name "*.sh" -exec chmod +x {} \;

# Set up the VA21 shell command
RUN echo '#!/bin/bash' > /usr/local/bin/va21 && \
    echo 'cd /va21 && python3 /va21/zork_shell/zork_interface.py' >> /usr/local/bin/va21 && \
    chmod +x /usr/local/bin/va21

# ============================================
# Environment Variables
# ============================================

ENV VA21_HOME=/va21
ENV VA21_USER=researcher
ENV VA21_BASE=alpine
ENV VA21_TYPE=desktop
ENV PYTHONUNBUFFERED=1
ENV TERM=xterm-256color

# ============================================
# Working Directory
# ============================================

WORKDIR /home/researcher

# ============================================
# Health Check
# ============================================

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python3 -c "import sys; sys.exit(0)"

# ============================================
# Expose Ports
# ============================================

EXPOSE 22
EXPOSE 5000

# ============================================
# Entrypoint
# ============================================

ENTRYPOINT ["/va21/entrypoint.sh"]
CMD ["zork"]
